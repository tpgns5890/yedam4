<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link href="/assets/css/modal.css" rel="stylesheet">
<!--headerFragment ì„ ì–¸-->
<div th:fragment="headerFragment">
  <div class="page-loader">
    <div class="loader">Loading...</div>
  </div>
  <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#custom-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">EVENTI</a>
      </div>
      <div class="collapse navbar-collapse" id="custom-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">ê²¬ì </a>
            <ul class="dropdown-menu">
              <li class="dropdown" sec:authorize="!hasRole('BUSI')"><a class="dropdown" href="/estForm">ê²¬ì ì‘ì„±</a></li>
              <li class="dropdown"><a class="dropdown" href="/estList">ê²¬ì ê²Œì‹œíŒ</a>
              </li>
            </ul>
          </li>
	  
          <li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">í¬íŠ¸í´ë¦¬ì˜¤</a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="/prtfl/mcList">ì‚¬íšŒì</a></li>
              <li><a href="/design/designList">ë””ìì¸</a></li>
              <li><a href="/prtfl/busiList">í–‰ì‚¬ì—…ì²´</a></li>
            </ul>
          </li>
          <li class="dropdown"><a href="/contest/List">ê³µëª¨ì „</a></li>
          <li class="dropdown"><a href="/jobList">êµ¬ì¸êµ¬ì§</a></li>
		
          <th:block sec:authorize="hasAnyRole('MC','DES','ADMIN')">
          <li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">ê²Œì‹œíŒ</a>
            <ul class="dropdown-menu" role="menu">
              <li class="dropdown"><a class="dropdown" href="/bboard/bList?type=T04">ììœ ê²Œì‹œíŒ</a></li>
              <li class="dropdown"><a class="dropdown" href="/bboard/bList?type=T05">ë©˜í† ë§ê²Œì‹œíŒ</a></li>
            </ul>
          </li>
          </th:block>
          
          <li class="dropdown"><a href="/proList">í™ë³´ê²Œì‹œíŒ</a></li>
          <li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">ê³µì§€ì‚¬í•­</a>
            <ul class="dropdown-menu" role="menu">
              <li class="dropdown"><a class="dropdown" href="/nocList">ê³µì§€ì‚¬í•­</a></li>
              <li class="dropdown"><a class="dropdown" href="/questions/myqnaList">Q&amp;A</a></li>
              <li class="dropdown"><a class="dropdown" href="/faqList">FAQ</a></li>
            </ul>
          </li>
          
          <li class="nav-item" sec:authorize="hasRole('ADMIN')"><a href="/admin/adminMain" class="nav-link">ì‚¬ì´íŠ¸ê´€ë¦¬</a>
          </li>
          <li class="nav-item" sec:authorize="isAuthenticated()"><a href="/myPage/userMypage" class="nav-link" th:text="${session.member.userId}"></a>
          </li>
          <li class="nav-item">
            <button class="btn btn-border-w btn-round btn-xs" th:onclick="|location.href='@{/memQualification}'|"
              sec:authorize='!isAuthenticated()' style="margin-top:11px;">íšŒì›ê°€ì…</button>
          </li>
          <li>
            <button class="btn btn-border-w btn-round btn-xs" sec:authorize='!isAuthenticated()' th:onclick="|location.href='@{/loginPage}'|"
              style="margin-top:11px;margin-left:3px;">ë¡œê·¸ì¸</button>
          </li>
          <li>
            <form method="post" action="../logout" sec:authorize="isAuthenticated()">
              <input th:name="${_csrf.parameterName}" type="hidden" th:value="${_csrf.token}" />
              <button class="btn btn-border-w btn-round btn-xs" type="submit" style="margin-top:11px;">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- í™”ë©´ í•˜ë‹¨ ì±„íŒ… ë²„íŠ¼ -->
	<div class="chat">
		<div class="background"></div>
		<svg class="chat-bubble" width="80" height="80" viewBox="0 0 100 100">
			<g class="bubble">
				<path class="line line1" d="M 30.7873,85.113394 30.7873,46.556405 C 30.7873,41.101961
          36.826342,35.342 40.898074,35.342 H 59.113981 C 63.73287,35.342
          69.29995,40.103201 69.29995,46.784744" />
				<path class="line line2" d="M 13.461999,65.039335 H 58.028684 C
            63.483128,65.039335
            69.243089,59.000293 69.243089,54.928561 V 45.605853 C
            69.243089,40.986964 65.02087,35.419884 58.339327,35.419884" />
			</g>
			<circle class="circle circle1" r="1.9" cy="50.7" cx="42.5" />
			<circle class="circle circle2" cx="49.9" cy="50.7" r="1.9" />
			<circle class="circle circle3" r="1.9" cy="50.7" cx="57.3" />
		</svg>
	</div>

	<!-- ì±„íŒ…ë²„íŠ¼ í´ë¦­ì‹œ ë‚˜íƒ€ë‚  ì±„íŒ…ì°½ -->
	<div class="chat-popup">
		<div class="chat-windows">
			<div class="chat-window-one">
				<!-- ì±„íŒ… popup -->
				<section class="message-area">
					<div class="container">
						<div class="row">
							<div class="col-12">
								<div class="chat-area">
									<!-- ì±„íŒ…ë°© -->
									<div class="chatlist">
										<div class="modal-dialog-scrollable">
											<div class="modal-content">
												<div class="chat-header">
													<ul class="nav nav-tabs" id="myTab" role="tablist">
														<li class="nav-item" role="presentation">
															<button class="nav-link active" id="Open-tab"
																data-bs-toggle="tab" data-bs-target="#Open"
																type="button" role="tab" aria-controls="Open"
																aria-selected="true">Chatting Room</button>
														</li>
													</ul>
												</div>

												<div class="modal-body">
													<!-- ì±„íŒ…ë°© ë‚˜íƒ€ë‚˜ëŠ” ê³³ -->
													<div class="chat-lists">
														<div class="tab-content" id="myTabContent">
															<!-- ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ -->
															<div class="chat-list">
																<a href="#" class="d-flex align-items-center">
																	<div class="flex-grow-1 ms-3">
																		<h3>ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
																	</div>
																</a>
															</div>
															<!-- ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ end -->
														</div>
													</div>
													<!-- ì±„íŒ…ë°© ë‚˜íƒ€ë‚˜ëŠ” ê³³ end -->
												</div>
											</div>
										</div>
									</div>
									<!-- ì±„íŒ…ë°© end -->

									<!-- ì±„íŒ…ê³µê°„ -->
									<div class="chatbox">
										<div class="modal-dialog-scrollable">
											<div class="modal-content" id="scroller">
												<div class="msg-head">
													<div class="row">
														<div class="col-8">
															<!--ëˆ„êµ¬ë‘ ì±„íŒ…í•˜ëŠ”ì§€ ë‚˜íƒ€ëƒ„-->
															<div class="d-flex align-items-center">
																<div class="flex-grow-1 ms-3">
																	<h3 id="toName">Mehedi Hasan</h3>
																</div>
															</div>
														</div>
													</div>
												</div>

												<!--ì±„íŒ…ë‚´ìš©-->
												<div class="modal-body">
													<div class="msg-body">
														<ul id="greetings">
														
														</ul>
													</div>
												</div>

												<!-- ì±„íŒ… ë³´ë‚´ëŠ” ê³µê°„ -->
												<div class="send-box">
													<form action="#">
														<input type="text" id="name" class="form-control"
															aria-label="messageâ€¦" placeholder="Write messageâ€¦">

														<button type="button" id="send" class="btn btn-default">
														<i class="fa fa-paper-plane" aria-hidden="true"></i>
															Send</button>
													</form>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
		</div>
	</div>
  
  <script>
	//csrf ì„¤ì •
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
    
    //ì±„íŒ…ë°©
    let cId = '';
    let fromId = '[[${session.member != null ? session.member.userId :""}]]';
       
    if(fromId != ''){
    	$(".chat").show();
    }
       
	let stompClient = null;
	//ì±„íŒ…ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
	$(".chat").on("click", function () {
		$(".chat").toggleClass("active");
		let toId = 'admin';
		
		//ì±„íŒ…ë°© êµ¬ë… ìƒì„±
		function createChatRoom() {
			let chatroomDataList = new Array();
			let chatroomData1 = {
					toId : toId,
					fromId : fromId
			};
			chatroomDataList.push(chatroomData1);
			let chatroomData2 = {
					toId : fromId,
					fromId : toId
			};
			chatroomDataList.push(chatroomData2);
						
			$.ajax({
	   			url : '/chatInsert',
	   			method : 'post',
	   			data : JSON.stringify(chatroomDataList),
	   			contentType : "application/json; charset=UTF-8",
	   			beforeSend : function(xhr)
	            {  
					xhr.setRequestHeader(header, token);
	            }
	   		}).then(res => {
	   			cId = res;
	   			chattingList()
	   		})
		}
		
		function chattingList(){
			$.ajax({
				url : '/chatSelect',
				method : 'post',
		   		data : JSON.stringify({fromId:fromId}),
		   		contentType : "application/json; charset=UTF-8",
		   		beforeSend : function(xhr)
			         {   
						xhr.setRequestHeader(header, token);
			         }
		   		}).then(res => {
		   				$(".chat-list").empty();
		   				for(r of res){
		   					console.log('r' + r);
		   					$(".chat-list").append(makeList(r));
		   			}
		   		})
	   	}
		
		function makeList(r){
			let list = `<a onclick="message('${r.cid}')" class="d-flex align-items-center">
							<div class="flex-grow-1 ms-3">
								<h3 id=${r.cid}>ğŸ””${r.toId}</h3>
							</div>
						</a>`;
						
			return list;
		}

		//ì±„íŒ…í™”ë©´ì´ ë‚˜íƒ€ë‚œë‹¤.
		if ($(".chat").hasClass("active")) {
			if(fromId != 'admin'){
				$.ajax({
					url : '/checkChat',
					method : 'post',
		   			data : JSON.stringify({toId:toId, fromId:fromId}),
		   			contentType : "application/json; charset=UTF-8",
		   			beforeSend : function(xhr)
		            {   
						xhr.setRequestHeader(header, token);
		            }
		   		}).then(res => {
		   			if(res != ''){
		   				console.log('res.cId:', res.cid);
		   				chattingList(res.cid);
		   			} else {
		   				createChatRoom();
		   			}
		   		})
			} else {
				$.ajax({
					url : '/chatSelect',
					method : 'post',
			   		data : JSON.stringify({fromId:fromId}),
			   		contentType : "application/json; charset=UTF-8",
			   		beforeSend : function(xhr)
				         {   
							xhr.setRequestHeader(header, token);
				         }
			   		}).then(res => {
			   			if(res.length >= 1){
			   				$(".chat-list").empty();
			   				for(r of res){
			   					console.log('r' + r);
			   					$(".chat-list").append(makeList(r));
			   				}
			   			}
			   		})
			}
			
			$(".chat-popup").show();
		}
	
		//ì±„íŒ…í™”ë©´ì´ ì‚¬ë¼ì§„ë‹¤.
		if (!$(".chat").hasClass("active")) {
			$(".chat-popup").hide();
			$(".chatbox").hide();
		}
	});
	
	function connect(chaId) {		
	   	//êµ¬ë…
	   	var socket = new SockJS('/gs-guide-websocket');
	    stompClient = Stomp.over(socket);
	    stompClient.connect({}, function (frame) {
	    //ë°©ë²ˆí˜¸ ì„¤ì •
	    cId = chaId;	
	    //ë°© êµ¬ë…í•˜ê¸°
	    stompClient.subscribe('/topic/chat/' + cId, function (chat) {  
	    //ì±„íŒ…ë‚´ìš© í™”ë©´ì¶œë ¥
	    var content = JSON.parse(chat.body);
	    let tag;
	    if(content.fromId == fromId){
		    tag = `<li class="repaly">
				          <p>${content.msgCntn}</p>
				       </li>`;
	    } else {
	    	 tag = `<li class="sender">
			          <p>${content.msgCntn}</p>
			        </li>`;
	    }
                 
		    $("#greetings").append(tag);
		    })
	 	})
	}

	   //ë©”ì‹œì§€ ë³´ë‚´ê¸°
	   $("#send").click(function sendMessage() {
		    console.log('ë©”ì‹œì§€ ë³´ë‚´ê¸°')
			stompClient.send("/app/chat", {}, JSON.stringify({
				 chaId : cId,
				 fromId : fromId,
				 msgCntn : $("#name").val()
			}));
			
			$("#name").val("");
		});
	   
	 //ì±„íŒ…ë°©ë¦¬ìŠ¤íŠ¸ì—ì„œ ì±„íŒ…ë°©ì„ ëˆŒë €ì„ ê²½ìš° ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
		function message(cId){
		 	if(stompClient !== null){
		 		stompClient.disconnect();
		 	}
		 
			$("#greetings").empty();
			chaId = cId;
			$('#toName').text($("#"+chaId).text());
			$.ajax({
				url : '/msgList',
				method : 'post',
		   		data : JSON.stringify({chaId:cId}),
		   		contentType : "application/json; charset=UTF-8",
		   		beforeSend : function(xhr)
			         {   
						xhr.setRequestHeader(header, token);
			         }
		   		}).then(res => {
					if(res.length > 0){
			   			for(r of res){
			   				if(r.fromId == fromId){
			   					console.log("message ë¶ˆëŸ¬ì˜¨ ì•„ì´")
			   				 	$("#greetings").append(fromTag(r));
			   				} else {
			   					$("#greetings").append(toTag(r));
			   				}
			   			}
					}
		   		})

			$(".chatbox").show();
			connect(chaId);
		}
		
		//ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
		function fromTag(r){
			let from = `<li class="repaly">
					        <p>${r.msgCntn}</p>
					        <span class="time">${r.sendDt}</span>
					      </li>`
			
			return from;
		}
		
		//ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€
		function toTag(r){
			let to = `<li class="sender">
						<p>${r.msgCntn}</p>
						<span class="time">${r.sendDt}</span>
					  </li>`
			
			return to;
		}
  </script>
</div>

</html>
